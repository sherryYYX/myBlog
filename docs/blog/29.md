## Recoil 使用及原理浅析
### 一、是什么
Recoil 是解决 React 全局数据流管理，采用 `分散管理的原子状态` 设计模式，支持`派生数据`和`异步查询`，基本功能上可以覆盖 Redux。
### 二、怎么用
#### (一) 作用域准备
`step1` 在最外层包一个 `RecoilRoot`
```javascript

import React from 'react';
import { RecoilRoot } from 'recoil';
 
function App() {
  return (
    <RecoilRoot>
        ...
    </RecoilRoot>
  );
}
```

#### (二) 跨组件共享数据
`step1:` 定义数据
* Recoil 通过`atom` 来定义一个状态。
```javascript 
const inputValueState = atom({
  key: "inputValue", //初始值
  default: ""
});
```
1. 这里定义了一个初始值 `inputValue`，默认为一个空字符串
2. 这里的 `key` 必须是唯一的。 

`step2:` 读取数据
* 采用 `Hooks` 方式读数据
```javascript

import React from "react";
import { useRecoilState } from "recoil";
import { inputValue } from "../store";
 
const InputA = () => {
  const [value, setValue] = useRecoilState(inputValueState);
 
  return <input value={value} onChange={e => setValue(e.target.value)} />;
};
 
export default InputA
```

* 注意
  1. 这样读数据是不是很简单？
  2. 但是 `Recoil API` 比较多
  3. 除了`useRecoilState`,还有`useSetRecoilState `,它只能改数据,数据变化不会让组件再渲染。

`step3:` 状态互相依赖（类似于vue的计算属性）
`Recoil` 中状态依赖用 `selector`

```javascript
const filterdInputValue = selector({
  key: "filterdInputValue",
  get: ({get}) => {
    // 通过 get 可以读取其它状态
    const inputValue = get(inputValueState);
    return inputValue.replace(/[0-9]/ig, "");
  },
});
```

`step4:` 异步
第一种方法：
`Recoil` 中处理异步请求用 `useRecoilValueLoadable`

```javascript
// 1. 用 selector 定义异步状态
const currentUserNameQuery = selector({
  key:'currentUserName',
  get:async ()=>{
    const res = await queryUserInfo()
    return res.name
  }
})

  export  {currentUserNameQuery}

// 2. 使用 useRecoilValueLoadable 返回状态

import React from "react";
import { useRecoilValueLoadable } from "recoil";
import {  currentUserNameQuery } from "../store/index";


const UserName = ()=>{
    const userNameLoadabel = useRecoilValueLoadable(currentUserNameQuery)
    switch(userNameLoadabel.state){
        case 'hasValue':
        return <div>{userNameLoadabel.contents}</div>
        case 'loading':
            return <div>{'加载中...'}</div>
        case 'hasError':
            throw userNameLoadabel.contents
        default:
            return null
    }
}

export default UserName

```

第二种方法：
```javascript
// 1. 声明组件
const UserName = ()=>{
    const username = useRecoilValue(currentUserNameQuery)
    return <div>{username}</div>
}

// 2.  React.Suspense 使用异步状态
    <React.Suspense fallback={<div>加载中。。。</div>}>
      <UserName/>
    </React.Suspense>
```







### 三、原理浅析